#!/bin/sh

set -Ceu

script=

while [ $# -gt 0 ]; do
    case "$1" in
        *)
            script=$1
            ;;
    esac
    shift
done

dirname=$(dirname $script)
fname=$(basename $script)

$(dirname $0)/build $script

for f in $dirname/*.in; do
    f2=$(echo $f | perl -nle '/^(.+)\.in$/ and print $1')
    echo $dirname/var/$fname-build/bin \< $f2.in \> $f2.result
    /bin/time $dirname/var/$fname-build/bin < $f2.in >| $f2.result
    diff -u --color=always $f2.result $f2.out && echo OK
done

